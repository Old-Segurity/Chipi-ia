#:import dp kivy.metrics.dp
#:import UIConfig src.config.UIConfig
#:import Clipboard kivy.core.clipboard.Clipboard

<SelectableLabel>:
    background_color: 0, 0, 0, 0
    background_normal: ''
    canvas.before:
        Color:
            rgba: (0.3, 0.3, 0.3, 0.1) if self.state == 'down' else (0, 0, 0, 0)
        Rectangle:
            pos: self.pos
            size: self.size

<LoginScreen>:
    canvas.before:
        Color:
            rgba: 0.08, 0.12, 0.18, 1
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        spacing: dp(12)
        padding: [dp(24), dp(24), dp(24), dp(16)]

        Widget:
            size_hint_y: 0.15

        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            spacing: dp(16)

            Label:
                text: "CHIPI IA"
                font_size: '36sp'
                color: 0.97, 0.85, 0.17, 1
                bold: True
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: dp(50)

            Label:
                text: "Vive la seguridad"
                font_size: '18sp'
                color: 0.8, 0.8, 0.8, 1
                halign: "center"
                size_hint_y: None
                height: dp(25)

        Widget:
            size_hint_y: None
            height: dp(20)

        Label:
            text: "Número de teléfono"
            font_size: '18sp'
            color: 1, 1, 1, 1
            halign: "left"
            size_hint_y: None
            height: dp(25)

        TextInput:
            id: telefono
            font_size: '20sp'
            multiline: False
            background_color: 0.95, 0.95, 0.97, 1
            foreground_color: 0.15, 0.20, 0.25, 1
            padding: [dp(15), dp(8), dp(15), dp(8)]
            size_hint_y: None
            height: dp(50)
            hint_text: "Ej: 3001234567"
            input_filter: 'int'
            on_text_validate: contrasena.focus = True  # Mejora: navegación con enter

        Label:
            text: "Contraseña"
            font_size: '18sp'
            color: 1, 1, 1, 1
            halign: "left"
            size_hint_y: None
            height: dp(25)

        TextInput:
            id: contrasena
            password: True
            font_size: '20sp'
            multiline: False
            background_color: 0.95, 0.95, 0.97, 1
            foreground_color: 0.15, 0.20, 0.25, 1
            padding: [dp(15), dp(8), dp(15), dp(8)]
            size_hint_y: None
            height: dp(50)
            hint_text: "Tu contraseña"
            on_text_validate: root.validate_and_login(telefono.text, contrasena.text)  # Mejora: enviar con enter

        Widget:
            size_hint_y: None
            height: dp(10)

        Button:
            text: "INICIAR SESIÓN"
            background_color: 0.97, 0.85, 0.17, 1
            color: 0.12, 0.13, 0.20, 1
            bold: True
            font_size: '20sp'
            size_hint_y: None
            height: dp(55)
            on_release: root.validate_and_login(telefono.text, contrasena.text)

        Button:
            text: "¿No tienes cuenta? CREAR CUENTA"
            background_color: 0, 0, 0, 0
            color: 0.97, 0.85, 0.17, 1
            font_size: '16sp'
            size_hint_y: None
            height: dp(40)
            on_release: app.sm.current = 'register'

        Widget:
            size_hint_y: 0.1

        Label:
            text: "OLD-SEGURITY Protección sin complicación"
            font_size: '14sp'
            color: 0.6, 0.65, 0.7, 1
            halign: "center"
            valign: "middle"
            size_hint_y: None
            height: dp(20)

<RegisterScreen>:
    canvas.before:
        Color:
            rgba: 0.08, 0.12, 0.18, 1
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        spacing: dp(12)
        padding: [dp(24), dp(24), dp(24), dp(16)]

        Widget:
            size_hint_y: 0.1

        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            spacing: dp(16)

            Label:
                text: "CREAR CUENTA"
                font_size: '36sp'
                color: 0.97, 0.85, 0.17, 1
                bold: True
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: dp(50)

            Label:
                text: "Completa la información para crear tu cuenta"
                font_size: '16sp'
                color: 0.8, 0.8, 0.8, 1
                halign: "center"
                size_hint_y: None
                height: dp(25)

        Widget:
            size_hint_y: None
            height: dp(15)

        Label:
            text: "Número de teléfono (10 dígitos)"
            font_size: '18sp'
            color: 1, 1, 1, 1
            halign: "left"
            size_hint_y: None
            height: dp(25)

        TextInput:
            id: telefono
            font_size: '20sp'
            multiline: False
            background_color: 0.95, 0.95, 0.97, 1
            foreground_color: 0.15, 0.20, 0.25, 1
            padding: [dp(15), dp(8), dp(15), dp(8)]
            size_hint_y: None
            height: dp(50)
            hint_text: "Ej: 3001234567"
            input_filter: 'int'
            on_text_validate: contrasena.focus = True

        Label:
            text: "Contraseña (mínimo 6 caracteres)"
            font_size: '18sp'
            color: 1, 1, 1, 1
            halign: "left"
            size_hint_y: None
            height: dp(25)

        TextInput:
            id: contrasena
            password: True
            font_size: '20sp'
            multiline: False
            background_color: 0.95, 0.95, 0.97, 1
            foreground_color: 0.15, 0.20, 0.25, 1
            padding: [dp(15), dp(8), dp(15), dp(8)]
            size_hint_y: None
            height: dp(50)
            hint_text: "Tu contraseña segura"
            on_text_validate: confirmar_contrasena.focus = True

        Label:
            text: "Confirmar contraseña"
            font_size: '18sp'
            color: 1, 1, 1, 1
            halign: "left"
            size_hint_y: None
            height: dp(25)

        TextInput:
            id: confirmar_contrasena
            password: True
            font_size: '20sp'
            multiline: False
            background_color: 0.95, 0.95, 0.97, 1
            foreground_color: 0.15, 0.20, 0.25, 1
            padding: [dp(15), dp(8), dp(15), dp(8)]
            size_hint_y: None
            height: dp(50)
            hint_text: "Repite tu contraseña"
            on_text_validate: root.validate_and_register(telefono.text, contrasena.text, confirmar_contrasena.text)

        Widget:
            size_hint_y: None
            height: dp(10)

        Button:
            text: "CREAR MI CUENTA"
            background_color: 0.2, 0.7, 0.2, 1
            color: 1, 1, 1, 1
            bold: True
            font_size: '20sp'
            size_hint_y: None
            height: dp(55)
            on_release: root.validate_and_register(telefono.text, contrasena.text, confirmar_contrasena.text)

        Button:
            text: "Ya tengo cuenta - INICIAR SESIÓN"
            background_color: 0, 0, 0, 0
            color: 0.97, 0.85, 0.17, 1
            font_size: '16sp'
            size_hint_y: None
            height: dp(40)
            on_release: app.sm.current = 'login'

        Widget:
            size_hint_y: 0.05

        Label:
            text: "OLD-SEGURITY Protección sin complicación"
            font_size: '14sp'
            color: 0.6, 0.65, 0.7, 1
            halign: "center"
            valign: "middle"
            size_hint_y: None
            height: dp(20)

<ChatScreen>:
    BoxLayout:
        orientation: 'vertical'
        canvas.before:
            Color:
                rgba: 0.05, 0.08, 0.12, 1
            Rectangle:
                pos: self.pos
                size: self.size

        # ENCABEZADO MEJORADO
        BoxLayout:
            size_hint_y: None
            height: dp(80)
            padding: [dp(10), dp(15), dp(10), dp(5)]
            spacing: dp(8)
            canvas.before:
                Color:
                    rgba: 0.08, 0.12, 0.18, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            # Botón de Ayuda
            Button:
                text: "Ayuda"
                background_normal: ''
                background_color: 0.2, 0.6, 0.8, 1
                color: 1, 1, 1, 1
                font_size: '14sp'
                size_hint_x: None
                width: dp(70)
                bold: True
                on_release: root.add_message("Puedo ayudarte con:\\n• Abrir aplicaciones\\n• Guardar contraseñas\\n• Crear recordatorios\\n• Responder preguntas\\n• Guardar información personal\\n\\nSolo háblame naturalmente!", "ia")

            # Espacio central para título
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(2)
                Label:
                    text: "CHIPI IA"
                    font_size: '28sp'
                    color: 0.97, 0.85, 0.17, 1
                    bold: True
                    halign: 'center'
                    valign: 'middle'
                Label:
                    text: "Vive la seguridad"
                    font_size: '14sp'
                    color: 0.7, 0.7, 0.7, 1
                    halign: 'center'
                    valign: 'middle'

            # Botón de Cerrar Sesión
            Button:
            	text: "Cerrar\nSesión"
            	halign: "center"
            	valign: "middle"
            	text_size: self.size
            	background_normal: ''
            	background_color: 0.8, 0.3, 0.3, 1
            	color: 1, 1, 1, 1
            	font_size: '14sp'
            	size_hint_x: None
            	width: dp(80)   # aumenta un poco el ancho
            	bold: True
            	on_release: app.logout()

        # MENSAJE DE BIENVENIDA
        Label:
            id: bienvenida_label
            text: root.bienvenida_text
            font_size: '18sp'
            color: 0.9, 0.9, 0.9, 1
            halign: 'left'
            valign: 'top'
            size_hint_y: None
            height: self.texture_size[1] + dp(20) if self.opacity == 1 else 0
            text_size: self.width - dp(32), None
            padding_x: dp(16)
            opacity: 1

        # ÁREA DE CONVERSACIÓN MEJORADA
        ScrollView:
            id: sv
            do_scroll_x: False
            do_scroll_y: True
            bar_width: 8
            scroll_y: 1
            effect_cls: 'ScrollEffect'
            BoxLayout:
                id: chat_area
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(12)
                padding: [dp(12), dp(12), dp(12), dp(12)]

        # BARRA DE ENTRADA MEJORADA
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height

            # Botón de detener audio (aparece solo cuando hay audio)
            Button:
                id: stop_audio_btn
                text: "Detener Audio"
                background_normal: ''
                background_color: 0.9, 0.3, 0.3, 1
                color: 1, 1, 1, 1
                font_size: '14sp'
                size_hint_y: None
                height: dp(40) if root.audio_playing else 0
                opacity: 1 if root.audio_playing else 0
                disabled: not root.audio_playing
                bold: True
                on_release: root.stop_audio()

            # Fila de entrada de texto y botón enviar
            BoxLayout:
                size_hint_y: None
                height: dp(70)
                spacing: dp(8)
                padding: [dp(12), dp(8), dp(12), dp(8)]
                canvas.before:
                    Color:
                        rgba: 0.12, 0.16, 0.22, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size

                TextInput:
                    id: entrada
                    font_size: '18sp'
                    multiline: True
                    input_type: 'text'
                    input_filter: None
                    background_normal: ''
                    background_color: 0.18, 0.22, 0.28, 1
                    foreground_color: 1, 1, 1, 1
                    cursor_color: 0.97, 0.85, 0.17, 1
                    hint_text: "Escribe tu mensaje aquí..."
                    hint_text_color: 0.7, 0.7, 0.7, 1
                    padding: [dp(15), dp(12), dp(15), dp(12)]
                    size_hint_x: 0.75
                    size_hint_y: None
                    height: dp(54)
                    on_focus:
                        root.scroll_to_bottom() if self.focus else None
                    on_text_validate: root.send_message()  # Mejora: enviar con enter

                Button:
                    text: "Enviar"
                    background_normal: ''
                    background_color: 0.97, 0.85, 0.17, 1
                    color: 0.12, 0.13, 0.20, 1
                    font_size: '16sp'
                    bold: True
                    size_hint_x: 0.25
                    on_release: root.send_message()